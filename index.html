<!DOCTYPE html>
<html>
  <head>
    <title>小蛋糕和小岛的旅行地图</title>
    <meta charset="utf-8" />
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
      .custom-info-window {
        padding: 10px;
        min-width: 200px;
      }
      .custom-info-window button {
        margin: 5px;
        padding: 5px 10px;
        cursor: pointer;
      }
      .delete-btn {
        background-color: #ff4d4d;
        color: white;
        border: none;
        border-radius: 3px;
      }
      .edit-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 3px;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        display: flex;
        gap: 10px;
      }
      #auth-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      }
      #address-search {
        display: flex;
        gap: 5px;
      }
      #address-input {
        padding: 5px;
        width: 200px;
      }
      .login-form {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .welcome-message {
        text-align: center;
        margin-bottom: 5px;
        font-weight: bold;
        color: #4CAF50;
      }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      let map;
      let markers = [];
      let currentInfoWindow = null;
      let isAuthenticated = false;
      let geocoder;
      let currentUser = null;

      // 更新后的用户名和密码
      const VALID_USERS = {
        "小蛋糕": "20250612",
        "小岛": "20250612"
      };

      // Firebase 配置
      const firebaseConfig = {
        apiKey: "AIzaSyCsxlzeLoQSy9sZFgme-119IpCIfyDN_XA",
        authDomain: "maps-b32b0.firebaseapp.com",
        databaseURL: "https://maps-b32b0-default-rtdb.firebaseio.com",
        projectId: "maps-b32b0",
        storageBucket: "maps-b32b0.appspot.com",
        messagingSenderId: "208074045290",
        appId: "1:208074045290:web:37e8a43580727551fa9713"
      };

      // 初始化 Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      function initMap() {
        // 默认定位到中国中心
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 35.8617, lng: 104.1954 }, // 中国中心坐标
          zoom: 4,
        });

        // 初始化地理编码器
        geocoder = new google.maps.Geocoder();

        // 从 Firebase 加载现有标记
        db.ref("markers").on("value", (snapshot) => {
          clearMarkers();
          const data = snapshot.val();
          if (data) {
            Object.keys(data).forEach(key => {
              const markerData = data[key];
              addMarker(
                { lat: markerData.lat, lng: markerData.lng }, 
                markerData.title, 
                false, 
                key
              );
            });
          }
        });

        // 点击地图时，新增标记并存入 Firebase
        map.addListener("click", (e) => {
          if (!isAuthenticated) {
            alert("请先登录以添加标记");
            return;
          }
          const position = { lat: e.latLng.lat(), lng: e.latLng.lng() };
          const title = prompt("给这个地点写个备注吧：", "");
          if (title !== null) {
            addMarker(position, title, true);
          }
        });

        // 添加控制界面
        initControls();
      }

      function initControls() {
        // 添加地址搜索框
        const controlsDiv = document.createElement('div');
        controlsDiv.id = 'controls';
        controlsDiv.innerHTML = `
          <div id="address-search">
            <input type="text" id="address-input" placeholder="输入地址搜索...">
            <button onclick="searchAddress()">搜索</button>
          </div>
        `;
        document.body.appendChild(controlsDiv);

        // 添加认证界面
        const authDiv = document.createElement('div');
        authDiv.id = 'auth-container';
        authDiv.innerHTML = `
          <div class="login-form">
            <div id="welcome-message" class="welcome-message" style="display:none;">欢迎，<span id="username-display"></span>！</div>
            <input type="text" id="username" placeholder="用户名" style="display:block;">
            <input type="password" id="password" placeholder="密码" style="display:block;">
            <button onclick="login()" style="display:block;" id="login-btn">登录</button>
            <button onclick="logout()" style="display:none;" id="logout-btn">退出登录</button>
          </div>
        `;
        document.body.appendChild(authDiv);

        // 检查本地存储中是否有登录状态
        const savedAuth = localStorage.getItem('mapAuth');
        if (savedAuth) {
          const authData = JSON.parse(savedAuth);
          document.getElementById('username').value = authData.username;
          document.getElementById('password').value = authData.password;
          login();
        }
      }

      function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (VALID_USERS[username] && VALID_USERS[username] === password) {
          isAuthenticated = true;
          currentUser = username;
          
          // 更新UI显示
          document.getElementById('logout-btn').style.display = 'block';
          document.getElementById('login-btn').style.display = 'none';
          document.getElementById('username').style.display = 'none';
          document.getElementById('password').style.display = 'none';
          document.getElementById('welcome-message').style.display = 'block';
          document.getElementById('username-display').textContent = username;
          
          // 保存登录状态到本地存储
          localStorage.setItem('mapAuth', JSON.stringify({ username, password }));
        } else {
          alert('用户名或密码错误');
        }
      }

      function logout() {
        isAuthenticated = false;
        currentUser = null;
        
        // 更新UI显示
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('login-btn').style.display = 'block';
        document.getElementById('username').style.display = 'block';
        document.getElementById('password').style.display = 'block';
        document.getElementById('welcome-message').style.display = 'none';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        
        // 清除本地存储的登录状态
        localStorage.removeItem('mapAuth');
      }

      function searchAddress() {
        const address = document.getElementById('address-input').value;
        if (!address) {
          alert('请输入地址');
          return;
        }

        geocoder.geocode({ address: address }, (results, status) => {
          if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(15);
            
            // 添加标记
            if (isAuthenticated) {
              const title = prompt("给这个地点写个备注吧：", address);
              if (title !== null) {
                addMarker(
                  { lat: location.lat(), lng: location.lng() },
                  title,
                  true
                );
              }
            }
          } else {
            alert('无法找到该地址: ' + status);
          }
        });
      }

      function addMarker(position, title = "", save = false, key = null) {
        const marker = new google.maps.Marker({
          position,
          map,
          title: title
        });

        // 存储 Firebase key 到标记对象
        if (key) {
          marker.firebaseKey = key;
        }

        // 创建信息窗口内容
        const infoContent = document.createElement("div");
        infoContent.className = "custom-info-window";
        
        const titleElement = document.createElement("div");
        titleElement.innerHTML = `<strong>${title || "未命名地点"}</strong>`;
        infoContent.appendChild(titleElement);
        
        // 只有认证用户才显示编辑和删除按钮
        if (isAuthenticated) {
          const editButton = document.createElement("button");
          editButton.className = "edit-btn";
          editButton.textContent = "编辑";
          editButton.onclick = () => {
            if (currentInfoWindow) currentInfoWindow.close();
            editMarker(marker);
          };
          infoContent.appendChild(editButton);
          
          const deleteButton = document.createElement("button");
          deleteButton.className = "delete-btn";
          deleteButton.textContent = "删除";
          deleteButton.onclick = () => {
            if (currentInfoWindow) currentInfoWindow.close();
            deleteMarker(marker);
          };
          infoContent.appendChild(deleteButton);
        }

        const infowindow = new google.maps.InfoWindow({
          content: infoContent
        });

        marker.addListener("click", () => {
          // 关闭之前打开的信息窗口
          if (currentInfoWindow) {
            currentInfoWindow.close();
          }
          
          infowindow.open(map, marker);
          currentInfoWindow = infowindow;
        });

        markers.push(marker);

        // 如果是用户新加的点，就保存到 Firebase
        if (save) {
          const newRef = db.ref("markers").push();
          newRef.set({
            lat: position.lat,
            lng: position.lng,
            title: title,
            createdBy: currentUser, // 记录创建者
            createdAt: new Date().toISOString() // 记录创建时间
          }).then(() => {
            // 保存成功后，更新标记的 Firebase key
            marker.firebaseKey = newRef.key;
          }).catch((error) => {
            console.error("保存标记时出错: ", error);
            alert("保存失败，请检查控制台查看错误详情");
          });
        }
      }

      function editMarker(marker) {
        if (!isAuthenticated) {
          alert("请先登录以编辑标记");
          return;
        }
        const newTitle = prompt("请输入新的地点名称：", marker.title || "");
        if (newTitle !== null) {
          // 更新标记的标题
          marker.setTitle(newTitle);
          marker.title = newTitle;
          
          // 更新 Firebase 中的数据
          if (marker.firebaseKey) {
            db.ref("markers").child(marker.firebaseKey).update({
              title: newTitle,
              updatedBy: currentUser, // 记录更新者
              updatedAt: new Date().toISOString() // 记录更新时间
            }).catch((error) => {
              console.error("更新标记时出错: ", error);
              alert("更新失败，请检查控制台查看错误详情");
            });
          }
          
          // 重新打开信息窗口以显示新标题
          google.maps.event.trigger(marker, 'click');
        }
      }

      function deleteMarker(marker) {
        if (!isAuthenticated) {
          alert("请先登录以删除标记");
          return;
        }
        if (confirm("确定要删除这个标记吗？")) {
          // 从 Firebase 中删除数据
          if (marker.firebaseKey) {
            db.ref("markers").child(marker.firebaseKey).remove()
              .catch((error) => {
                console.error("删除标记时出错: ", error);
                alert("删除失败，请检查控制台查看错误详情");
              });
          }
          
          // 从地图上移除标记
          marker.setMap(null);
          
          // 从标记数组中移除
          const index = markers.indexOf(marker);
          if (index > -1) {
            markers.splice(index, 1);
          }
        }
      }

      function clearMarkers() {
        markers.forEach((m) => {
          m.setMap(null);
        });
        markers = [];
      }
    </script>
  </head>
  <body>
    <div id="map"></div>
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIlfymkqVb52HxyvJrvl2QjEn0exXMSTc&callback=initMap">
    </script>
  </body>
</html>
